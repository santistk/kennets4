<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
<ui:composition template="/WEB-INF/templates/layout.xhtml">
    <ui:define name="content">
        <h:form id="formProjects">
            <div class="card">
                <h2>Proyectos</h2>
                
                <div style="margin-bottom: 1rem;">
                    <div class="p-inputgroup" style="margin-bottom: 0.5rem;">
                        <p:inputText id="searchQuery" 
                                   value="#{projectController.searchQuery}" 
                                   placeholder="Buscar por nombre o propietario"
                                   style="width: 300px;"/>
                        <p:selectOneMenu id="filterStatus" 
                                       value="#{projectController.filterStatus}" 
                                       style="width: 200px;">
                            <f:selectItem itemLabel="Todos los estados" itemValue="#{null}"/>
                            <f:selectItems value="#{projectController.statuses}" var="status"
                                         itemLabel="#{status}" itemValue="#{status}"/>
                        </p:selectOneMenu>
                        <p:commandButton value="Buscar"
                                       actionListener="#{projectController.search}"
                                       update=":formProjects:tableProjects :formProjects:msgs"
                                       icon="pi pi-search"/>
                        <p:commandButton value="Limpiar"
                                       actionListener="#{projectController.clearFilters}"
                                       update=":formProjects:tableProjects :formProjects:msgs :formProjects:searchQuery :formProjects:filterStatus"
                                       icon="pi pi-times"
                                       styleClass="p-button-secondary"/>
                    </div>
                    <p:commandButton value="Nuevo Proyecto"
                                   actionListener="#{projectController.newProject}"
                                   update=":formProjects:dialogProject"
                                   oncomplete="PF('dlgProject').show()"
                                   icon="pi pi-plus"/>
                </div>

                <p:messages id="msgs" closable="true"/>

                <p:dataTable id="tableProjects"
                           value="#{projectController.projects}"
                           var="project"
                           paginator="true"
                           rows="10"
                           responsiveLayout="scroll"
                           styleClass="p-datatable-striped p-datatable-gridlines"
                           emptyMessage="No hay proyectos">
                    <p:column headerText="ID" width="80" sortBy="#{project.id}">
                        #{project.id}
                    </p:column>

                    <p:column headerText="Nombre" sortBy="#{project.name}">
                        <b>#{project.name}</b>
                    </p:column>

                    <p:column headerText="Descripción" width="300">
                        <h:outputText value="#{project.description}" 
                                    rendered="#{project.description != null and not empty project.description}"/>
                        <span class="muted" rendered="#{project.description == null or empty project.description}">-</span>
                    </p:column>

                    <p:column headerText="Propietario" sortBy="#{project.owner}">
                        #{project.owner}
                    </p:column>

                    <p:column headerText="Estado" sortBy="#{project.status}" width="120">
                        <p:tag value="#{project.status}" 
                             severity="#{project.status == 'ACTIVE' ? 'success' : project.status == 'ON_HOLD' ? 'warning' : 'info'}"/>
                    </p:column>

                    <p:column headerText="Creado" sortBy="#{project.createdAt}" width="180">
                        #{project.createdAt}
                    </p:column>

                    <p:column headerText="Acciones" width="200">
                        <p:commandButton icon="pi pi-pencil"
                                       actionListener="#{projectController.editProject(project)}"
                                       update=":formProjects:dialogProject"
                                       oncomplete="PF('dlgProject').show()"
                                       styleClass="p-button-sm p-button-rounded p-button-text"
                                       title="Editar"/>
                        <p:commandButton icon="pi pi-list"
                                       actionListener="#{projectController.selectProject(project)}"
                                       update=":formProjects:panelTasks"
                                       styleClass="p-button-sm p-button-rounded p-button-text"
                                       title="Ver Tareas"/>
                        <p:commandButton icon="pi pi-trash"
                                       actionListener="#{projectController.deleteProject(project)}"
                                       update=":formProjects:tableProjects :globalGrowl :formProjects:panelTasks"
                                       styleClass="p-button-sm p-button-rounded p-button-danger p-button-text"
                                       title="Eliminar"
                                       onclick="return confirm('¿Está seguro de eliminar el proyecto \'#{project.name}\'?');"/>
                    </p:column>
                </p:dataTable>
            </div>

            <!-- Panel de tareas del proyecto seleccionado -->
            <h:panelGroup id="panelTasks" layout="block" styleClass="card" 
                        rendered="#{projectController.selectedProject != null}">
                <ui:include src="fragments/tasks-by-project.xhtml"/>
            </h:panelGroup>

            <!-- Diálogo para crear/editar proyecto -->
            <p:dialog id="dialogProject"
                    header="#{projectController.editingProject != null and projectController.editingProject.id != null ? 'Editar Proyecto' : 'Nuevo Proyecto'}"
                    widgetVar="dlgProject"
                    modal="true"
                    closable="true"
                    resizable="false"
                    style="width: 600px;">
                <h:form id="formDialogProject">
                    <h:panelGroup id="dialogContent">
                        <p:messages id="dialogMsgs" closable="true"/>
                        
                        <h:panelGrid columns="2" columnClasses="label,value" style="width: 100%;">
                            <h:outputLabel for="name" value="Nombre *"/>
                            <p:inputText id="name" 
                                       value="#{projectController.editingProject.name}"
                                       required="true"
                                       requiredMessage="El nombre es obligatorio"
                                       style="width: 100%;">
                                <f:validator validatorId="uniqueProjectNameValidator"/>
                                <f:attribute name="currentProjectId" value="#{projectController.editingProject.id}"/>
                            </p:inputText>

                            <h:outputLabel for="owner" value="Propietario *"/>
                            <p:inputText id="owner"
                                       value="#{projectController.editingProject.owner}"
                                       required="true"
                                       requiredMessage="El propietario es obligatorio"
                                       style="width: 100%;"/>

                            <h:outputLabel for="status" value="Estado"/>
                            <p:selectOneMenu id="status"
                                           value="#{projectController.editingProject.status}"
                                           style="width: 100%;">
                                <f:selectItems value="#{projectController.statuses}" var="status"
                                             itemLabel="#{status}" itemValue="#{status}"/>
                            </p:selectOneMenu>

                            <h:outputLabel for="description" value="Descripción"/>
                            <p:inputTextarea id="description"
                                            value="#{projectController.editingProject.description}"
                                            rows="4"
                                            style="width: 100%;"/>
                        </h:panelGrid>

                        <div style="margin-top:1rem; display:flex; gap:.5rem; justify-content:flex-end;">
                            <p:commandButton value="Guardar"
                                           actionListener="#{projectController.saveProject}"
                                           process="@form"
                                           update=":formProjects:tableProjects :formProjects:msgs :globalGrowl :formProjects:panelTasks"
                                           oncomplete="if(!args.validationFailed) { PF('dlgProject').hide(); }"
                                           icon="pi pi-check"/>
                            <p:commandButton value="Cancelar"
                                           type="button"
                                           onclick="PF('dlgProject').hide(); return false;"
                                           styleClass="p-button-secondary"
                                           icon="pi pi-times"/>
                        </div>
                    </h:panelGroup>
                </h:form>
            </p:dialog>
        </h:form>
    </ui:define>
</ui:composition>
</html>

