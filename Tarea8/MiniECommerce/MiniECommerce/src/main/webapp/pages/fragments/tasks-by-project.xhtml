<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
<ui:composition>
    <h:panelGroup id="tasksPanel" layout="block">
        <h2>Tareas del Proyecto: #{taskController.currentProject.name}</h2>
        
        <h:panelGroup id="tasksSummary" style="margin-bottom: 1rem; padding: 0.75rem; background: #f5f5f5; border-radius: 0.5rem; display: block;">
            <strong>Resumen: </strong>
            Tareas abiertas: <strong>#{taskController.openTasksCount}</strong> / 
            Completadas: <strong>#{taskController.completedTasksCount}</strong>
        </h:panelGroup>

        <h:form id="formTasks">
            <div style="margin-bottom: 1rem;">
                <div class="p-inputgroup" style="margin-bottom: 0.5rem;">
                    <p:selectOneMenu value="#{taskController.filterPriority}" 
                                   style="width: 200px;">
                        <f:selectItem itemLabel="Todas las prioridades" itemValue="#{null}"/>
                        <f:selectItems value="#{taskController.priorities}" var="priority"
                                     itemLabel="#{priority}" itemValue="#{priority}"/>
                        <p:ajax event="change" 
                              listener="#{taskController.filterByPriority}"
                              update=":formTasks:tableTasks :formTasks:tasksSummary"/>
                    </p:selectOneMenu>
                    <p:commandButton value="Nueva Tarea"
                                   actionListener="#{taskController.newTask}"
                                   update=":formTasks:dialogTask"
                                   oncomplete="PF('dlgTask').show()"
                                   icon="pi pi-plus"/>
                </div>
            </div>
            <p:messages id="msgs" closable="true"/>

            <p:dataTable id="tableTasks"
                       value="#{taskController.tasks}"
                       var="task"
                       paginator="true"
                       rows="10"
                       responsiveLayout="scroll"
                       styleClass="p-datatable-striped p-datatable-gridlines"
                       rowStyleClass="#{taskController.isOverdue(task) ? 'row-danger' : ''}"
                       emptyMessage="No hay tareas">
                <p:column headerText="ID" width="80" sortBy="#{task.id}">
                    #{task.id}
                </p:column>

                <p:column headerText="Título" sortBy="#{task.title}">
                    <b>#{task.title}</b>
                </p:column>

                <p:column headerText="Prioridad" sortBy="#{task.priority}" width="120">
                    <p:tag value="#{task.priority}" 
                         severity="#{task.priority == 'HIGH' ? 'danger' : task.priority == 'MEDIUM' ? 'warning' : 'info'}"/>
                </p:column>

                <p:column headerText="Fecha Vencimiento" sortBy="#{task.dueDate}" width="150">
                    #{task.dueDate}
                    <p:badge value="Vencida" 
                           rendered="#{taskController.isOverdue(task)}"
                           severity="danger"
                           style="margin-left: 0.5rem;"/>
                </p:column>

                <p:column headerText="Estado" width="120">
                    <p:tag value="#{task.done ? 'Completada' : 'Pendiente'}" 
                         severity="#{task.done ? 'success' : 'warning'}"/>
                </p:column>

                <p:column headerText="Notas" width="200">
                    <h:outputText value="#{task.notes}" 
                                rendered="#{task.notes != null and not empty task.notes}"/>
                    <span class="muted" rendered="#{task.notes == null or empty task.notes}">-</span>
                </p:column>

                <p:column headerText="Acciones" width="200">
                    <p:commandButton icon="pi #{task.done ? 'pi-undo' : 'pi-check'}"
                                   actionListener="#{taskController.toggleDone(task)}"
                                   update=":formTasks:tableTasks :formTasks:tasksSummary :globalGrowl"
                                   styleClass="p-button-sm p-button-rounded p-button-text"
                                   title="#{task.done ? 'Marcar como pendiente' : 'Marcar como completada'}"/>
                    <p:commandButton icon="pi pi-pencil"
                                   actionListener="#{taskController.editTask(task)}"
                                   update=":formTasks:dialogTask"
                                   oncomplete="PF('dlgTask').show()"
                                   styleClass="p-button-sm p-button-rounded p-button-text"
                                   title="Editar"/>
                    <p:commandButton icon="pi pi-trash"
                                   actionListener="#{taskController.deleteTask(task)}"
                                   update=":formTasks:tableTasks :formTasks:tasksSummary :globalGrowl"
                                   styleClass="p-button-sm p-button-rounded p-button-danger p-button-text"
                                   title="Eliminar"
                                   onclick="return confirm('¿Está seguro de eliminar la tarea \'#{task.title}\'?');"/>
                </p:column>
            </p:dataTable>

            <!-- Diálogo para crear/editar tarea -->
            <p:dialog id="dialogTask"
                    header="#{taskController.editingTask != null and taskController.editingTask.id != null ? 'Editar Tarea' : 'Nueva Tarea'}"
                    widgetVar="dlgTask"
                    modal="true"
                    closable="true"
                    resizable="false"
                    style="width: 600px;">
                <h:form id="formDialogTask">
                    <h:panelGroup id="dialogContent">
                        <p:messages id="dialogMsgs" closable="true"/>
                        
                        <h:panelGrid columns="2" columnClasses="label,value" style="width: 100%;">
                            <h:outputLabel for="taskTitle" value="Título *"/>
                            <p:inputText id="taskTitle" 
                                       value="#{taskController.editingTask.title}"
                                       required="true"
                                       requiredMessage="El título es obligatorio"
                                       style="width: 100%;"/>

                            <h:outputLabel for="taskPriority" value="Prioridad"/>
                            <p:selectOneMenu id="taskPriority"
                                           value="#{taskController.editingTask.priority}"
                                           style="width: 100%;">
                                <f:selectItems value="#{taskController.priorities}" var="priority"
                                             itemLabel="#{priority}" itemValue="#{priority}"/>
                            </p:selectOneMenu>

                            <h:outputLabel for="taskDueDate" value="Fecha de Vencimiento"/>
                            <p:calendar id="taskDueDate"
                                      value="#{taskController.editingTask.dueDate}"
                                      pattern="yyyy-MM-dd"
                                      mindate="#{java.time.LocalDate.now()}"
                                      style="width: 100%;">
                                <f:validator validatorId="futureOrTodayDateValidator"/>
                            </p:calendar>

                            <h:outputLabel for="taskDone" value="Completada"/>
                            <p:selectBooleanCheckbox id="taskDone"
                                                   value="#{taskController.editingTask.done}"/>

                            <h:outputLabel for="taskNotes" value="Notas"/>
                            <p:inputTextarea id="taskNotes"
                                           value="#{taskController.editingTask.notes}"
                                           rows="4"
                                           style="width: 100%;"/>
                        </h:panelGrid>

                        <div style="margin-top:1rem; display:flex; gap:.5rem; justify-content:flex-end;">
                            <p:commandButton value="Guardar"
                                           actionListener="#{taskController.saveTask}"
                                           process="@form"
                                           update=":formTasks:tableTasks :formTasks:tasksSummary :formTasks:msgs :globalGrowl"
                                           oncomplete="if(!args.validationFailed) { PF('dlgTask').hide(); }"
                                           icon="pi pi-check"/>
                            <p:commandButton value="Cancelar"
                                           type="button"
                                           onclick="PF('dlgTask').hide(); return false;"
                                           styleClass="p-button-secondary"
                                           icon="pi pi-times"/>
                        </div>
                    </h:panelGroup>
                </h:form>
            </p:dialog>
        </h:form>
    </h:panelGroup>
</ui:composition>
</html>

